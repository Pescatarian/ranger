<!DOCTYPE html>
<html>
<head>
    <title>Ranger</title>
    <style>
       body {
    background-color: #1a1a1a;
    color: #4CAF50;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    display: flex;
    user-select: none;
}

/* Main Container Styles */
.main-container {
    flex: 1;
    padding: 20px;
}

.grid-container {
    display: grid;
    grid-template-columns: repeat(8, 100px);
    gap: 1px;
    background-color: #2d2d2d;
    padding: 1px;
    width: fit-content;
    aspect-ratio: 1;
}

/* Cell Styles */
.cell {
    width: 100px;
    height: 100px;
    background-color: #1a1a1a;
    border: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
}

.cell-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cell-id {
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 12px;
    opacity: 0.7;
}

/* Button Styles */
.button {
    padding: 8px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
    transition: all 0.3s ease;
}

.button.active {
    background-color: #45a049;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    border: 2px solid #fff;
    transform: scale(1.05);
}

/* Range Builder Sidebar */
.sidebar {
    width: 600px;
    background-color: #2d2d2d;
    padding: 10px;
    border-left: 1px solid #444;
    display: none;
    position: fixed;
    right: 0;
    top: 0;
    height: 100vh;
    flex-direction: column;
    align-items: center;
}

.sidebar h2 {
    color: #4CAF50;
    margin-top: 20px;
    width: 100%;
    padding-left: 20px;
}

/* View Controls */
.view-controls {
    width: 520px;
    display: flex;
    gap: 8px;
    margin: 3px auto;
    padding: 3px 0;
    justify-content: center;
}

.view-button {
    padding: 6px 12px;
    min-width: 70px;
    background-color: #2d2d2d;
    color: #4CAF50;
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.view-button.active {
    background-color: #4CAF50;
    color: white;
    border-color: white;
}

/* Range Grid */
.range-grid {
    display: grid;
    grid-template-columns: repeat(13, 1fr);
    gap: 1px;
    margin: 8px auto;
    width: 520px;
    aspect-ratio: 1;
    margin-bottom: 8px;
}

.range-cell {
    aspect-ratio: 1;
    background-color: #1a1a1a;
    border: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    cursor: pointer;
    color: white;
    position: relative;
    overflow: hidden;
}

.range-cell:hover {
    background-color: #2d2d2d;
}

.range-cell.selected {
    color: white;
    position: relative;
    z-index: 1;
    transition: background 0.3s ease;
}

.range-cell span {
    z-index: 2;
    position: relative;
}

/* Controls Layout */
.controls {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1000;
}

/* Row Controls */
.top-controls {
    width: 520px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 10px auto;
    padding: 0;
    background-color: #2d2d2d;
    border-radius: 4px;
}

.control-row {
    display: flex;
    justify-content: flex-start; /* Changed from space-between */
    align-items: center;
    width: 520px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.3s ease;
    opacity: 0.7;
    box-sizing: border-box;
    background-color: #1a1a1a;  /* Add this for the dark background only in the rows */
}

.control-row.active {
    opacity: 1;
}

/* Color and Weight Controls */
.color-weight-group {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: nowrap;
    white-space: nowrap;
}

.weight-control {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    flex-wrap: nowrap;
    margin-left: 8px;
}

.row-toggle {
    min-width: 20px;
    min-height: 20px;
    width: 20px;
    height: 20px;
    background-color: #2d2d2d;
    border: 2px solid #666;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: 10px;
    padding: 0;
    font-size: 0;
    position: relative;
    display: inline-block;
    flex: 0 0 20px;
}

.row-toggle.active {
    border-color: #4CAF50;
    box-shadow: 0 1px 3px rgba(76,175,80,0.6);
}

.row-toggle.active::after {
    content: '';
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #4CAF50;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    top: 50%;
    left: 50%;
}
.weight-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    margin: 0 5px;
    background-image: url("data:image/svg+xml,%3Csvg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 500 500' style='enable-background: new 0 0 299.799 299.799' xml:space='preserve' width='500' height='500'%3E%3Cpath fill='%234CAF50' d='M478.988 470.569 -53.084 -296.163 25.017 25.017 0 0 0 -24.625 -20.602h-88.284 16.553 -16.384 26.84 -38.954 26.84 -63.97C339.834 40.299 299.536 0 250.001 05160.166 40.299 160.166 89.834c0 25.015 10.207 47.665 26.84 63.97M98.721a25.017 25.017 0 0 0 -24.625 20.602l21.012 470.569a25.013 25.013 0 0 0 24.625 29.43M408.726a25.017 25.017 0 0 0 24.625 -29.43M250.001 50.034c21.946 0 39.8 17.854 39.8 39.852271.947 129.635 250.001 129.635s-39.802 -17.855 -39.802 -39.802S228.054 50.034 250.001 50.034m-6.538 337.103a7.455 7.455 0 0 1 -6.549 3.898h-11.801a7.455 7.455 0 0 1 -6.491 -3.686l-29.206 -49.858 -18.678 19.066v22.96a11.518 11.518 0 0 1 -23.035 0V288.46a11.518 11.518 0 0 1 23.035 0v39.145l44.328 -48.252a7.455 7.455 0 0 1 5.487 -2.41h10.128a7.453 7.453 0 0 1 5.359 12.631l-30.747 31.805 37.809 58.141a7.455 7.455 0 0 1 0.302 7.618m113.481 -15.194c0 2.265 -1.034 4.416 -2.804 5.829q-6.895 5.502 -18.167 9.875 -13.739 5.33 -27.824 5.33c-11.935 0 -22.333 -2.502 -31.209 -7.51q-13.306 -7.508 -20 -21.479 -6.693 -13.968 -6.693 -30.39 0 -17.822 7.472 -31.673 7.47 -13.853 21.87 -21.248 10.969 -5.68 27.315 -5.682 21.246 0 33.192 8.913a38.859 38.859 0 0 1 8.751 8.999 11.758 11.758 0 0 1 1.229 11.167 11.758 11.758 0 0 1 -8.709 7.101l-0.027 0.005a11.391 11.391 0 0 1 -11.736 -5.132 23.516 23.516 0 0 0 -6.616 -4.863 -16.616 -4.863 -15.1 0 -24.008 9.571 -8.911 9.576 -8.911 28.407 -0.002 20.314 9.028 30.469 9.026 10.155 23.659 10.155 7.235 0 14.513 -2.84 7.273 -2.842 12.49 -6.886v-14.478h-16.77a9.61 9.61 0 1 1 0 -19.22h32.587a7.455 7.455 0 0 1 7.452 7.452z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    vertical-align: middle;
}
        
/* Stats Container */
.stats-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-left: auto; /* This will push it to the right */
}

.stat-box {
    display: flex;
    align-items: center;
    gap: 3px;
    color: #4CAF50;
    white-space: nowrap;
    min-width: 100px; /* Ensure consistent width */
}
        
/* Input and Stats Styles */
.color-input {
    width: 25px;
    height: 25px;
    padding: 0;
    border: none;
    background: #1a1a1a;
    cursor: pointer;
    overflow: hidden;
}

.stat-value {
    background: #1a1a1a;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #444;
    min-width: 45px;
    text-align: center;
}

.weight-input {
    width: 50px;
    background: #1a1a1a;
    color: #4CAF50;
    border: 1px solid #444;
    padding: 4px;
    border-radius: 4px;
    text-align: center;
}

/* Bottom Controls */
.range-text {
    width: 520px;
    height: 80px;
    background-color: #1a1a1a;
    color: #4CAF50;
    border: 1px solid #444;
    padding: 8px;
    margin: 3px auto;
    font-family: Arial, sans-serif;
    resize: none;
    box-sizing: border-box;
}

.button-container {
    width: 520px;
    display: flex;
    justify-content: space-between;
    margin: 3px auto;
    gap: 10px;
}

.save-button, .clear-button {
    width: 100px;
    height: 35px;
    padding: 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-weight: bold;
    line-height: 35px;
}

.save-button {
    background-color: #4CAF50;
}

.clear-button {
    background-color: #ff4444;
}

.save-button:hover {
    background-color: #45a049;
}

.clear-button:hover {
    background-color: #ff3333;
}

/* Hover Effects */
.view-button:hover:not(.active),
.row-toggle:hover:not(.active) {
    background-color: #3d3d3d;
}
     </style>
</head>
<body>
    <div class="main-container">
        <div class="controls">
            <button id="viewModeBtn" class="button active" onclick="toggleViewMode()">View Mode</button>
            <button id="rangeBuilderBtn" class="button" onclick="toggleRangeBuilder()">Range Builder</button>
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2>Range Builder</h2>
        
        <!-- View Mode Controls -->
        <div class="view-controls">
            <button class="view-button active" data-view="all">Show All</button>
            <button class="view-button" data-view="row1">Show 1</button>
            <button class="view-button" data-view="row2">Show 2</button>
        </div>

        <div class="range-grid" id="rangeGrid"></div>
        
        <!-- Control Rows Container -->
        <div class="top-controls">
           <!-- First Control Row -->
<div class="control-row active">
    <button class="row-toggle active" data-row="1">Row 1</button>
    <div class="weight-control">
        <div class="color-weight-group">
            <label>Color</label>
            <input type="color" id="colorPicker1" value="#4CAF50" class="color-input">
            <label for="weightInput1" class="weight-icon"></label>
            <input type="number" id="weightInput1" value="100" min="0" max="100" 
                   class="weight-input" onchange="updateWeight(this.value, 1)">
        </div>
    </div>
    <div class="stats-container">
        <div class="stat-box">
            <span>%Range</span>
            <span id="rangePercent1" class="stat-value">0</span>
        </div>
        <div class="stat-box">
            <span>Combos</span>
            <span id="comboCount1" class="stat-value">0</span>
        </div>
    </div>
</div>

<!-- Second Control Row -->
<div class="control-row">
    <button class="row-toggle" data-row="2">Row 2</button>
    <div class="weight-control">
        <div class="color-weight-group">
            <label>Color</label>
            <input type="color" id="colorPicker2" value="#FF0000" class="color-input">
            <label for="weightInput2" class="weight-icon"></label>
            <input type="number" id="weightInput2" value="100" min="0" max="100" 
                   class="weight-input" onchange="updateWeight(this.value, 2)">
        </div>
    </div>
    <div class="stats-container">
        <div class="stat-box">
            <span>%Range</span>
            <span id="rangePercent2" class="stat-value">0</span>
        </div>
        <div class="stat-box">
            <span>Combos</span>
            <span id="comboCount2" class="stat-value">0</span>
        </div>
    </div>
</div>
    
        <textarea id="rangeText" class="range-text" 
                  oninput="handleRangeTextChange(event)"></textarea>
        
        <!-- Bottom Buttons Container -->
        <div class="button-container">
            <button class="save-button" onclick="saveToCell()">Save to Cell</button>
            <button class="clear-button" onclick="clearSelection()">Clear</button>
        </div>
    </div>
</body>

    <script>
let isViewMode = true;
let isRangeBuilderOpen = false;
let selectedCell = null;
const cellData = new Map();
let currentWeights = [100, 100];
let currentColors = ['#4CAF50', '#FF0000'];
let activeRow = 0;
let isMouseDown = false;
let isSelecting = null;
let currentView = 'all';

function createGrid() {
    const grid = document.getElementById('grid');
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const cellId = `${String.fromCharCode(65 + j)}${i + 1}`;
            
            const cellContent = document.createElement('div');
            cellContent.className = 'cell-content';
            
            const cellIdSpan = document.createElement('span');
            cellIdSpan.className = 'cell-id';
            cellIdSpan.textContent = cellId;
            
            cell.appendChild(cellIdSpan);
            cell.appendChild(cellContent);
            cell.dataset.id = cellId;
            
            cell.addEventListener('click', selectCell);
            cell.setAttribute('draggable', true);
            cell.addEventListener('dragstart', handleDragStart);
            cell.addEventListener('dragover', handleDragOver);
            cell.addEventListener('drop', handleDrop);
            
            grid.appendChild(cell);
        }
    }
}

function createRangeGrid() {
    const rangeGrid = document.getElementById('rangeGrid');
    const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
    
    for (let i = 0; i < ranks.length; i++) {
        for (let j = 0; j < ranks.length; j++) {
            const cell = document.createElement('div');
            cell.className = 'range-cell';
            
            const textSpan = document.createElement('span');
            if (i === j) {
                textSpan.textContent = ranks[i] + ranks[j];
            } else if (i < j) {
                textSpan.textContent = ranks[i] + ranks[j] + 's';
            } else {
                textSpan.textContent = ranks[j] + ranks[i] + 'o';
            }
            cell.appendChild(textSpan);

            cell.addEventListener('mousedown', startRangeSelection);
            cell.addEventListener('mouseover', updateRangeSelection);
            
            rangeGrid.appendChild(cell);
        }
    }
    
    document.addEventListener('mouseup', endRangeSelection);
}

function updateWeight(value, rowIndex) {
    const adjustedIndex = rowIndex - 1;
    currentWeights[adjustedIndex] = Math.min(Math.max(0, parseInt(value)), 100);
    document.getElementById(`weightInput${rowIndex}`).value = currentWeights[adjustedIndex];
    activeRow = adjustedIndex;
    saveColorSettings(adjustedIndex);
    updateStats();
}

function updateColor(e) {
    const rowIndex = e.target.id === 'colorPicker1' ? 0 : 1;
    const color = e.target.value;
    if (/^#[0-9A-F]{6}$/i.test(color)) {
        currentColors[rowIndex] = color;
        activeRow = rowIndex;
        saveColorSettings(rowIndex);
        updateRangeDisplay(currentView);
    } else {
        console.warn('Invalid color format:', color);
        e.target.value = currentColors[rowIndex];
    }
}

function handleViewChange(e) {
    document.querySelectorAll('.view-button').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    
    currentView = e.target.dataset.view;
    updateRangeDisplay(currentView);
}

function handleRowToggle(e) {
    document.querySelectorAll('.row-toggle').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.control-row').forEach(row => row.classList.remove('active'));
    
    e.target.classList.add('active');
    e.target.closest('.control-row').classList.add('active');
    
    activeRow = parseInt(e.target.dataset.row) - 1;
}

function updateRangeDisplay(view) {
    const cells = document.querySelectorAll('.range-cell');
    
    cells.forEach(cell => {
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        switch(view) {
            case 'row1':
                cell.style.opacity = selections.some(s => s.color === currentColors[0]) ? '1' : '0.3';
                break;
            case 'row2':
                cell.style.opacity = selections.some(s => s.color === currentColors[1]) ? '1' : '0.3';
                break;
            case 'all':
                cell.style.opacity = '1';
                break;
        }
    });
}

function saveColorSettings(rowIndex) {
    const color = currentColors[rowIndex];
    const weight = currentWeights[rowIndex];
    localStorage.setItem(`savedColor${rowIndex + 1}`, JSON.stringify({ color, weight }));
}

function updateStats() {
    const selectedCells = document.querySelectorAll('.range-cell');
    let totalCombos = [0, 0];
    
    selectedCells.forEach(cell => {
        const hand = cell.querySelector('span').textContent;
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        if (selections.length === 0) return;
        
        let handCombos = 0;
        if (hand.length === 2) {
            handCombos = 6;
        } else if (hand.endsWith('s')) {
            handCombos = 4;
        } else if (hand.endsWith('o')) {
            handCombos = 12;
        }
        
        selections.forEach(selection => {
            const rowIndex = currentColors.indexOf(selection.color);
            if (rowIndex !== -1) {
                totalCombos[rowIndex] += handCombos * (selection.weight / 100);
            }
        });
    });
    
    const totalPossibleCombos = 1326;
    totalCombos.forEach((combos, index) => {
        const rangePercentage = (combos / totalPossibleCombos * 100).toFixed(1);
        document.getElementById(`rangePercent${index + 1}`).textContent = rangePercentage + '%';
        document.getElementById(`comboCount${index + 1}`).textContent = Math.round(combos);
    });
}

function toggleRangeCell(cell) {
    // First check if the clicked row toggle is active
    const activeRowToggle = document.querySelector(`.row-toggle[data-row="${activeRow + 1}"]`);
    if (!activeRowToggle?.classList.contains('active')) return;

    if (!cell.dataset.selections) {
        cell.dataset.selections = JSON.stringify([]);
    }
    
    let selections = JSON.parse(cell.dataset.selections);
    const currentColor = currentColors[activeRow];
    const currentWeight = currentWeights[activeRow];
    
    const otherRowSelections = selections.filter(s => currentColors.indexOf(s.color) !== activeRow);
    const existingSelection = selections.find(s => currentColors.indexOf(s.color) === activeRow);

    if (existingSelection) {
        if (existingSelection.color === currentColor && existingSelection.weight === currentWeight) {
            selections = otherRowSelections;
        } else {
            selections = [...otherRowSelections, { color: currentColor, weight: currentWeight }];
        }
    } else {
        selections = [...otherRowSelections, { color: currentColor, weight: currentWeight }];
    }
    
    cell.dataset.selections = JSON.stringify(selections);
    updateCellVisual(cell);
    updateRangeText();
    updateStats();
}

function updateCellVisual(cell) {
    const selections = JSON.parse(cell.dataset.selections || '[]');
    
    if (selections.length === 0) {
        cell.style.background = '#1a1a1a';
        cell.classList.remove('selected');
        return;
    }

    cell.classList.add('selected');
    
    if (selections.length === 1) {
        const {color, weight} = selections[0];
        cell.style.background = `linear-gradient(to right, ${color} ${weight}%, #1a1a1a ${weight}%)`;
    } else {
        // Sort selections by row index for consistent gradient ordering
        selections.sort((a, b) => currentColors.indexOf(a.color) - currentColors.indexOf(b.color));
        
        let gradientString = 'linear-gradient(to right, ';
        let currentPosition = 0;
        
        selections.forEach((selection, index) => {
            gradientString += `${selection.color} ${currentPosition}% ${currentPosition + selection.weight}%`;
            currentPosition += selection.weight;
            
            if (index < selections.length - 1) {
                gradientString += ', ';
            }
        });
        
        gradientString += `, #1a1a1a ${currentPosition}%)`;
        cell.style.background = gradientString;
    }
}

function clearSelection() {
    document.querySelectorAll('.range-cell').forEach(cell => {
        cell.dataset.selections = JSON.stringify([]);
        updateCellVisual(cell);
    });
    document.getElementById('rangeText').value = '';
    updateStats();
}

function handleRangeTextChange(e) {
    const text = e.target.value.trim();
    
    document.querySelectorAll('.range-cell').forEach(cell => {
        cell.dataset.selections = JSON.stringify([]);
        updateCellVisual(cell);
    });
    
    if (text) {
        const weightGroups = text.match(/\[\d+:[#\w]+\][^[]+\[\/\d+\]/g) || [];
        weightGroups.forEach(group => {
            const [_, weight, color] = group.match(/\[(\d+):([#\w]+)\]/);
            const hands = group.match(/\]([^[]+)\[/)[1].split(',');
            
            hands.forEach(hand => {
                const cell = [...document.querySelectorAll('.range-cell')]
                    .find(cell => cell.querySelector('span').textContent.trim() === hand.trim());
                if (cell) {
                    const selections = JSON.parse(cell.dataset.selections || '[]');
                    selections.push({color, weight: parseInt(weight)});
                    cell.dataset.selections = JSON.stringify(selections);
                    updateCellVisual(cell);
                }
            });
        });
    }
    updateStats();
} 

function startRangeSelection(e) {
    isMouseDown = true;
    const cell = e.target.closest('.range-cell');
    const selections = JSON.parse(cell.dataset.selections || '[]');
    isSelecting = !selections.some(s => s.color === currentColors[activeRow]);
    toggleRangeCell(cell);
}

function updateRangeSelection(e) {
    if (!isMouseDown || isSelecting === null) return;
    const cell = e.target.closest('.range-cell');
    if (!cell) return;
    
    const selections = JSON.parse(cell.dataset.selections || '[]');
    const hasCurrentColor = selections.some(s => s.color === currentColors[activeRow]);
    
    if (hasCurrentColor !== isSelecting) {
        toggleRangeCell(cell);
    }
}

function endRangeSelection() {
    isMouseDown = false;
    isSelecting = null;
}

function toggleViewMode() {
    isViewMode = true;
    isRangeBuilderOpen = false;
    
    document.getElementById('viewModeBtn').classList.add('active');
    document.getElementById('rangeBuilderBtn').classList.remove('active');
    
    document.getElementById('sidebar').style.display = 'none';
}

function toggleRangeBuilder() {
    isRangeBuilderOpen = !isRangeBuilderOpen;
    isViewMode = !isRangeBuilderOpen;
    
    document.getElementById('viewModeBtn').classList.toggle('active', !isRangeBuilderOpen);
    document.getElementById('rangeBuilderBtn').classList.toggle('active', isRangeBuilderOpen);
    
    document.getElementById('sidebar').style.display = isRangeBuilderOpen ? 'flex' : 'none';
}

function updateRangeText() {
    const cells = [...document.querySelectorAll('.range-cell')];
    const selectionsByColorAndWeight = {};
    
    cells.forEach(cell => {
        const selections = JSON.parse(cell.dataset.selections || '[]');
        selections.forEach(({color, weight}) => {
            const key = `${color}_${weight}`;
            if (!selectionsByColorAndWeight[key]) {
                selectionsByColorAndWeight[key] = [];
            }
            selectionsByColorAndWeight[key].push(cell.querySelector('span').textContent);
        });
    });
    
    const formattedGroups = Object.entries(selectionsByColorAndWeight)
        .map(([key, hands]) => {
            const [color, weight] = key.split('_');
            return `[${weight}:${color}]${hands.join(',')}[/${weight}]`;
        });
    
    document.getElementById('rangeText').value = formattedGroups.join(',');
}

function selectCell(e) {
    if (!isViewMode) return;
    if (selectedCell) {
        selectedCell.style.border = '1px solid #444';
    }
    selectedCell = e.currentTarget;
    selectedCell.style.border = '2px solid #4CAF50';
}

function saveToCell() {
    if (!selectedCell) {
        alert('Please select a cell first');
        return;
    }
    
    const rangeText = document.getElementById('rangeText').value;
    if (rangeText && !rangeText.match(/^\[[\d]+:[#\w]+\][^[]+\[\/\d+\](,\[[\d]+:[#\w]+\][^[]+\[\/\d+\])*$/)) {
        alert('Invalid range format');
        return;
    }
    
    cellData.set(selectedCell.dataset.id, rangeText);
    const content = selectedCell.querySelector('.cell-content');
    content.innerHTML = '📝';
    
    toggleRangeBuilder();
}

function handleDragStart(e) {
    if (!isViewMode) return;
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
}

function handleDragOver(e) {
    if (!isViewMode) return;
    e.preventDefault();
}

function handleDrop(e) {
    if (!isViewMode) return;
    e.preventDefault();
    const sourceId = e.dataTransfer.getData('text/plain');
    const targetId = e.target.closest('.cell').dataset.id;
    
    const sourceData = cellData.get(sourceId);
    const targetData = cellData.get(targetId);
    
    if (sourceData) cellData.set(targetId, sourceData);
    if (targetData) cellData.set(sourceId, targetData);
    
    updateCellContent(sourceId);
    updateCellContent(targetId);
}

function updateCellContent(cellId) {
    const cell = document.querySelector(`[data-id="${cellId}"]`);
    const content = cell.querySelector('.cell-content');
    const data = cellData.get(cellId);
    content.innerHTML = data ? '📝' : '';
}

function loadSavedColors() {
    for (let i = 1; i <= 2; i++) {
        const saved = localStorage.getItem(`savedColor${i}`);
        if (saved) {
            const { color, weight } = JSON.parse(saved);
            document.getElementById(`colorPicker${i}`).value = color;
            document.getElementById(`weightInput${i}`).value = weight;
            currentColors[i - 1] = color;
            currentWeights[i - 1] = weight;
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    createGrid();
    createRangeGrid();
    toggleViewMode();
    
    document.getElementById('colorPicker1').addEventListener('input', updateColor);
    document.getElementById('colorPicker2').addEventListener('input', updateColor);
    
    document.querySelectorAll('.view-button').forEach(button => {
        button.addEventListener('click', handleViewChange);
    });
    
    document.querySelectorAll('.row-toggle').forEach(button => {
        button.addEventListener('click', handleRowToggle);
    });
    
    loadSavedColors();
});
</script>
</body>
</html>    

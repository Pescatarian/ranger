<!DOCTYPE html>
<html>
<head>
    <title>Ranger</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #4CAF50;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            user-select: none;
        }

        .main-container {
            flex: 1;
            padding: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(8, 100px);
            gap: 1px;
            background-color: #2d2d2d;
            padding: 1px;
            width: fit-content;
            aspect-ratio: 1;
        }

        .cell {
            width: 100px;
            height: 100px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }

        .cell-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell-id {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 12px;
            opacity: 0.7;
        }

        .button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .button.active {
            background-color: #45a049;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            border: 2px solid #fff;
            transform: scale(1.05);
        }

        /* Range Builder Sidebar */
        .sidebar {
            width: 600px;
            background-color: #2d2d2d;
            padding: 20px;
            border-left: 1px solid #444;
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            flex-direction: column;
            align-items: center;
        }

       .sidebar h2 {
            color: #4CAF50;
            margin-top: 20px;  /* Reduced from 60px to 20px */
            width: 100%;
            padding-left: 20px;
    }

.range-grid {
    display: grid;
    grid-template-columns: repeat(13, 1fr);
    gap: 4px;
    margin: 10px 20px;  /* Reduced top margin from 20px to 10px */
    width: calc(100% - 40px);
    aspect-ratio: 1;
    margin-bottom: 20px;
}
        .range-cell {
            aspect-ratio: 1;
            background-color: #1a1a1a;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            color: #4CAF50;
            position: relative;
            overflow: hidden;
        }

        .range-cell:hover {
            background-color: #2d2d2d;
        }

                .range-cell.selected {
                    color: white;
                    position: relative;
                    z-index: 1;
                    transition: background 0.3s ease;
            }
    
        .range-cell span {
            z-index: 2;
            position: relative;
        }

        .controls {
    position: fixed;
    top: 20px;
    right: 30px; /* Increased from 20px for more space from edge */
    display: flex;
    gap: 15px; /* Increased from 10px for better button spacing */
    z-index: 1000;
}

 .top-controls {
    width: calc(100% - 40px);
    margin: 10px 20px;
    display: flex;
    justify-content: flex-start; /* Changed from space-between */
    align-items: center;
    gap: 30px; /* Increased from 20px */
}

.weight-control {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #4CAF50;
    min-width: 250px; /* Increased from 200px */
    flex-shrink: 0; /* Prevent shrinking */
}

.stats-container {
    display: flex;
    gap: 30px; /* Increased from 20px */
    align-items: center;
    flex-shrink: 0; /* Prevent shrinking */
}

.color-weight-group {
    display: flex;
    align-items: center;
    gap: 10px; /* Increased from 8px */
    flex-wrap: nowrap;
    white-space: nowrap; /* Added to prevent text wrapping */
}

.stat-box {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #4CAF50;
    white-space: nowrap; /* Prevent wrapping */
}

       .color-input {
            width: 40px;
            height: 30px;
            padding: 0;
            border: 1px solid #444;
            border-radius: 4px;
            background: #1a1a1a;
            cursor: pointer;
        }
    
         .stat-value {
            background: #1a1a1a;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #444;
            min-width: 50px;
            text-align: center;
        }

        .weight-input {
            width: 60px;
            background: #1a1a1a;
            color: #4CAF50;
            border: 1px solid #444;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }

 .clear-button {
    padding: 8px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: auto; /* Push to the right */
    flex-shrink: 0; /* Prevent shrinking */
}

.clear-button:hover {
    background-color: #45a049;
}
         
.range-text {
    width: calc(100% - 40px);
    height: 40px;
    background-color: #1a1a1a;
    color: #4CAF50;
    border: 1px solid #444;
    padding: 10px;
    margin-top: 30px;  /* Increased from 20px to 30px */
    font-family: Arial, sans-serif;
    resize: none;
}

.save-button {
    width: calc(100% - 40px);
    margin-top: 5px;
}

         .cell[draggable="true"] {
            cursor: move;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="controls">
            <button id="viewModeBtn" class="button active" onclick="toggleViewMode()">View Mode</button>
            <button id="rangeBuilderBtn" class="button" onclick="toggleRangeBuilder()">Range Builder</button>
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2>Range Builder</h2>
        <div class="range-grid" id="rangeGrid"></div>
        <div class="top-controls">
            <div class="weight-control">
                <div class="color-weight-group">
                    <label>Color:</label>
                    <input type="color" id="colorPicker" value="#4CAF50" class="color-input">
                    <label for="weightInput">Weight:</label>
                    <input type="number" id="weightInput" value="100" min="0" max="100" 
                           class="weight-input" onchange="updateWeight(this.value)">
                    <span>%</span>
                </div>
            </div>
            <div class="stats-container">
                <div class="stat-box">
                    <span>Range:</span>
                    <span id="rangePercent" class="stat-value">0%</span>
                </div>
                <div class="stat-box">
                    <span>Combos:</span>
                    <span id="comboCount" class="stat-value">0</span>
                </div>
            </div>
            <button class="clear-button" onclick="clearSelection()">Clear</button>
        </div>
        <textarea id="rangeText" class="range-text" 
                  oninput="handleRangeTextChange(event)"></textarea>
        <button class="button save-button" onclick="saveToCell()">Save to Cell</button>
    </div>
    <script>
    let isViewMode = true;
    let isRangeBuilderOpen = false;
    let selectedCell = null;
    const cellData = new Map();
    let currentWeight = 100;
    let currentColor = '#4CAF50';
    let isMouseDown = false;
    let isSelecting = null;

    function createGrid() {
        const grid = document.getElementById('grid');
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const cellId = `${String.fromCharCode(65 + j)}${i + 1}`;
                
                const cellContent = document.createElement('div');
                cellContent.className = 'cell-content';
                
                const cellIdSpan = document.createElement('span');
                cellIdSpan.className = 'cell-id';
                cellIdSpan.textContent = cellId;
                
                cell.appendChild(cellIdSpan);
                cell.appendChild(cellContent);
                cell.dataset.id = cellId;
                
                cell.addEventListener('click', selectCell);
                cell.setAttribute('draggable', true);
                cell.addEventListener('dragstart', handleDragStart);
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('drop', handleDrop);
                
                grid.appendChild(cell);
            }
        }
    }

    function createRangeGrid() {
        const rangeGrid = document.getElementById('rangeGrid');
        const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
        
        for (let i = 0; i < ranks.length; i++) {
            for (let j = 0; j < ranks.length; j++) {
                const cell = document.createElement('div');
                cell.className = 'range-cell';
                
                const textSpan = document.createElement('span');
                if (i === j) {
                    // Pocket pairs
                    textSpan.textContent = ranks[i] + ranks[j];
                } else if (i < j) {
                    // Suited hands on the right side
                    textSpan.textContent = ranks[i] + ranks[j] + 's';
                } else {
                    // Offsuit hands on the left side
                    textSpan.textContent = ranks[j] + ranks[i] + 'o';
                }
                cell.appendChild(textSpan);

                cell.addEventListener('mousedown', startRangeSelection);
                cell.addEventListener('mouseover', updateRangeSelection);
                
                rangeGrid.appendChild(cell);
            }
        }
        
        document.addEventListener('mouseup', endRangeSelection);
    }

   function updateStats() {
    const selectedCells = document.querySelectorAll('.range-cell');
    let totalCombos = 0;
    
    selectedCells.forEach(cell => {
        const hand = cell.querySelector('span').textContent;
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        if (selections.length === 0) return;
        
        let handCombos = 0;
        if (hand.length === 2) {
            handCombos = 6; // Pocket pair
        } else if (hand.endsWith('s')) {
            handCombos = 4; // Suited
        } else if (hand.endsWith('o')) {
            handCombos = 12; // Offsuit
        }
        
        // Calculate total weight percentage (capped at 100%)
        const totalWeight = Math.min(
            selections.reduce((sum, s) => sum + (s.weight || 0), 0),
            100
        ) / 100;
        
        totalCombos += handCombos * totalWeight;
    });
    
    const totalPossibleCombos = 1326;
    const rangePercentage = (totalCombos / totalPossibleCombos * 100).toFixed(1);
    
    document.getElementById('rangePercent').textContent = rangePercentage + '%';
    document.getElementById('comboCount').textContent = Math.round(totalCombos);
}

   function updateColor(e) {
    const color = e.target.value;
    // Validate color format
    if (/^#[0-9A-F]{6}$/i.test(color)) {
        currentColor = color;
    } else {
        console.warn('Invalid color format:', color);
        e.target.value = currentColor; // Reset to previous valid color
    }
}

  function toggleRangeCell(cell) {
    if (!cell.dataset.selections) {
        cell.dataset.selections = JSON.stringify([]);
    }
    
    let selections = JSON.parse(cell.dataset.selections);
    const existingSelectionIndex = selections.findIndex(s => s.color === currentColor);
    const totalCurrentWeight = selections.reduce((sum, s) => sum + s.weight, 0);

    if (existingSelectionIndex >= 0) {
        // If same color exists, update its weight
        selections[existingSelectionIndex].weight = currentWeight;
    } else {
        // If adding new color
        if (totalCurrentWeight + currentWeight > 100) {
            // Adjust existing selections proportionally
            const remainingWeight = 100 - currentWeight;
            const ratio = remainingWeight / totalCurrentWeight;
            selections = selections.map(s => ({
                ...s,
                weight: Math.round(s.weight * ratio)
            }));
        }
        // Add new selection
        selections.push({
            color: currentColor,
            weight: currentWeight
        });
    }

    // Remove selections with 0 weight
    selections = selections.filter(s => s.weight > 0);
    
    cell.dataset.selections = JSON.stringify(selections);
    updateCellVisual(cell);
    updateRangeText();
    updateStats();
}

    function updateCellVisual(cell) {
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        if (selections.length === 0) {
            cell.style.background = '#1a1a1a';
            cell.classList.remove('selected');
            return;
        }

        cell.classList.add('selected');
        
        if (selections.length === 1) {
            const {color, weight} = selections[0];
            cell.style.background = `linear-gradient(to right, ${color} ${weight}%, #1a1a1a ${weight}%)`;
        } else {
            let gradientString = 'linear-gradient(to right, ';
            let currentPosition = 0;
            
            selections.forEach((selection, index) => {
                gradientString += `${selection.color} ${currentPosition}% ${currentPosition + selection.weight}%`;
                currentPosition += selection.weight;
                
                if (index < selections.length - 1) {
                    gradientString += ', ';
                }
            });
            
            gradientString += `, #1a1a1a ${currentPosition}%)`;
            cell.style.background = gradientString;
        }
    }

    function clearSelection() {
        document.querySelectorAll('.range-cell').forEach(cell => {
            cell.dataset.selections = JSON.stringify([]);
            updateCellVisual(cell);
        });
        document.getElementById('rangeText').value = '';
        updateStats();
    }

    function handleRangeTextChange(e) {
        const text = e.target.value.trim();
        
        document.querySelectorAll('.range-cell').forEach(cell => {
            cell.dataset.selections = JSON.stringify([]);
            updateCellVisual(cell);
        });
        
        if (text) {
            const weightGroups = text.match(/\[\d+:[#\w]+\][^[]+\[\/\d+\]/g) || [];
            weightGroups.forEach(group => {
                const [_, weight, color] = group.match(/\[(\d+):([#\w]+)\]/);
                const hands = group.match(/\]([^[]+)\[/)[1].split(',');
                
                hands.forEach(hand => {
                    const cell = [...document.querySelectorAll('.range-cell')]
                        .find(cell => cell.querySelector('span').textContent.trim() === hand.trim());
                    if (cell) {
                        const selections = JSON.parse(cell.dataset.selections || '[]');
                        selections.push({color, weight: parseInt(weight)});
                        cell.dataset.selections = JSON.stringify(selections);
                        updateCellVisual(cell);
                    }
                });
            });
        }
        updateStats();
    }

    function startRangeSelection(e) {
    isMouseDown = true;
    const cell = e.target.closest('.range-cell');
    const selections = JSON.parse(cell.dataset.selections || '[]');
    isSelecting = !selections.some(s => s.color === currentColor);
    toggleRangeCell(cell);
}

    function updateRangeSelection(e) {
    if (!isMouseDown || isSelecting === null) return;
    const cell = e.target.closest('.range-cell');
    if (!cell) return;
    
    const selections = JSON.parse(cell.dataset.selections || '[]');
    const hasCurrentColor = selections.some(s => s.color === currentColor);
    
    if (hasCurrentColor !== isSelecting) {
        toggleRangeCell(cell);
    }
}

    function endRangeSelection() {
        isMouseDown = false;
        isSelecting = null;
    }

    function updateWeight(value) {
        currentWeight = Math.min(Math.max(0, value), 100);
        document.getElementById('weightInput').value = currentWeight;
    }

    function toggleViewMode() {
        isViewMode = true;
        isRangeBuilderOpen = false;
        
        document.getElementById('viewModeBtn').classList.add('active');
        document.getElementById('rangeBuilderBtn').classList.remove('active');
        
        document.getElementById('sidebar').style.display = 'none';
    }

    function toggleRangeBuilder() {
        isRangeBuilderOpen = !isRangeBuilderOpen;
        isViewMode = !isRangeBuilderOpen;
        
        document.getElementById('viewModeBtn').classList.toggle('active', !isRangeBuilderOpen);
        document.getElementById('rangeBuilderBtn').classList.toggle('active', isRangeBuilderOpen);
        
        document.getElementById('sidebar').style.display = isRangeBuilderOpen ? 'flex' : 'none';
    }

    function updateRangeText() {
        const cells = [...document.querySelectorAll('.range-cell')];
        const selectionsByColorAndWeight = {};
        
        cells.forEach(cell => {
            const selections = JSON.parse(cell.dataset.selections || '[]');
            selections.forEach(({color, weight}) => {
                const key = `${color}_${weight}`;
                if (!selectionsByColorAndWeight[key]) {
                    selectionsByColorAndWeight[key] = [];
                }
                selectionsByColorAndWeight[key].push(cell.querySelector('span').textContent);
            });
        });
        
        const formattedGroups = Object.entries(selectionsByColorAndWeight)
            .map(([key, hands]) => {
                const [color, weight] = key.split('_');
                return `[${weight}:${color}]${hands.join(',')}[/${weight}]`;
            });
        
        document.getElementById('rangeText').value = formattedGroups.join(',');
    }

    function selectCell(e) {
        if (!isViewMode) return;
        if (selectedCell) {
            selectedCell.style.border = '1px solid #444';
        }
        selectedCell = e.currentTarget;
        selectedCell.style.border = '2px solid #4CAF50';
    }

   function saveToCell() {
    if (!selectedCell) {
        alert('Please select a cell first');
        return;
    }
    
    const rangeText = document.getElementById('rangeText').value;
    // Validate the range text format
    if (rangeText && !rangeText.match(/^\[[\d]+:[#\w]+\][^[]+\[\/\d+\](,\[[\d]+:[#\w]+\][^[]+\[\/\d+\])*$/)) {
        alert('Invalid range format');
        return;
    }
    
    cellData.set(selectedCell.dataset.id, rangeText);
    const content = selectedCell.querySelector('.cell-content');
    content.innerHTML = '📝';
    
    toggleRangeBuilder();
}

    function handleDragStart(e) {
        if (!isViewMode) return;
        e.dataTransfer.setData('text/plain', e.target.dataset.id);
    }

    function handleDragOver(e) {
        if (!isViewMode) return;
        e.preventDefault();
    }

    function handleDrop(e) {
        if (!isViewMode) return;
        e.preventDefault();
        const sourceId = e.dataTransfer.getData('text/plain');
        const targetId = e.target.closest('.cell').dataset.id;
        
        const sourceData = cellData.get(sourceId);
        const targetData = cellData.get(targetId);
        
        if (sourceData) cellData.set(targetId, sourceData);
        if (targetData) cellData.set(sourceId, targetData);
        
        updateCellContent(sourceId);
        updateCellContent(targetId);
    }

    function updateCellContent(cellId) {
        const cell = document.querySelector(`[data-id="${cellId}"]`);
        const content = cell.querySelector('.cell-content');
        const data = cellData.get(cellId);
        content.innerHTML = data ? '📝' : '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        createGrid();
        createRangeGrid();
        toggleViewMode();
        document.getElementById('colorPicker').addEventListener('input', updateColor);
    });
</script>
</body>
</html>

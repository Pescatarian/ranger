<!DOCTYPE html>
<html>
<head>
    <title>Ranger</title>
    <style>
       body {
    background-color: #1a1a1a;
    color: #4CAF50;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    display: flex;
    user-select: none;
}

/* Main Container Styles */
.main-container {
    flex: 1;
    padding: 20px;
}

.grid-container {
    display: grid;
    grid-template-columns: repeat(8, 100px);
    gap: 1px;
    background-color: #2d2d2d;
    padding: 1px;
    width: fit-content;
    aspect-ratio: 1;
}

/* Cell Styles */
.cell {
    width: 100px;
    height: 100px;
    background-color: #1a1a1a;
    border: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
}

.cell-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cell-id {
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 12px;
    opacity: 0.7;
}

/* Button Styles */
.button {
    padding: 8px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
    transition: all 0.3s ease;
}

.button.active {
    background-color: #45a049;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    border: 2px solid #fff;
    transform: scale(1.05);
}

/* Range Builder Sidebar */
.sidebar {
    width: 600px;
    background-color: #2d2d2d;
    padding: 10px;
    border-left: 1px solid #444;
    display: none;
    position: fixed;
    right: 0;
    top: 0;
    height: 100vh;
    flex-direction: column;
    align-items: center;
}

.sidebar h2 {
    color: #4CAF50;
    margin-top: 20px;
    width: 100%;
    padding-left: 20px;
}

/* View Controls */
.view-controls {
    width: 520px;
    display: flex;
    gap: 8px;
    margin: 3px auto;
    padding: 3px 0;
    justify-content: center;
}

.view-button {
    padding: 6px 12px;
    min-width: 70px;
    background-color: #2d2d2d;
    color: #4CAF50;
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.view-button.active {
    background-color: #4CAF50;
    color: white;
    border-color: white;
}

/* Range Grid */
.range-grid {
    display: grid;
    grid-template-columns: repeat(13, 1fr);
    gap: 1px;
    margin: 8px auto;
    width: 520px;
    aspect-ratio: 1;
    margin-bottom: 8px;
}

.range-cell {
    aspect-ratio: 1;
    background-color: #1a1a1a;
    border: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    cursor: pointer;
    color: white;
    position: relative;
    overflow: hidden;
}

.range-cell:hover {
    background-color: #2d2d2d;
}

.range-cell.selected {
    color: white;
    position: relative;
    z-index: 1;
    transition: background 0.3s ease;
}

.range-cell span {
    z-index: 2;
    position: relative;
}

/* Controls Layout */
.controls {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1000;
}

/* Row Controls */
.top-controls {
    width: 520px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 10px auto;
    padding: 0;
    background-color: #2d2d2d;
    border-radius: 4px;
}

/* Row Controls */
.control-row {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 520px;
    padding: 4px 0;
    border-radius: 4px;
    background-color: #1a1a1a;
    gap: 12px; /* Equal spacing between all groups */
    opacity: 0.7; /* Add this line */
}
        
.control-row.active {
    opacity: 1;
}

/* Row Toggle Button */
.row-toggle {
    min-width: 20px;
    min-height: 20px;
    width: 20px;
    height: 20px;
    background-color: #2d2d2d;
    border: 2px solid #666;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    font-size: 0;
    position: relative;
    display: inline-block;
    flex: 0 0 20px;
}

.row-toggle.active {
    border-color: #4CAF50;
    box-shadow: 0 1px 3px rgba(76,175,80,0.6);
}

.row-toggle.active::after {
    content: '';
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #4CAF50;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    top: 50%;
    left: 50%;
}
  
/* Stat Boxes and Groups */
.stat-box {
    display: flex;
    align-items: center;
    gap: 3px; /* Consistent spacing between label and value */
    color: #4CAF50;
    white-space: nowrap;
}

 /* Excel color picker */
.color-picker-panel {
    position: fixed;
    background: #2d2d2d;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 12px;
    width: 280px;
    display: none;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.color-section {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #444;
}

.color-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-label {
    color: #fff;
    font-size: 12px;
    margin-bottom: 8px;
    font-weight: 500;
}

.theme-colors-grid,
.standard-colors-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 3px;
}

.recent-colors-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 3px;
    margin-top: 4px;
}

.color-swatch {
    width: 100%;
    aspect-ratio: 1;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    border-radius: 2px;
    transition: transform 0.1s ease;
}

.color-swatch:hover {
    transform: scale(1.1);
    border-color: #fff;
}

.color-options {
    margin-top: 12px;
}

.option-button {
    width: 100%;
    padding: 8px;
    background: #2d2d2d;
    border: 1px solid #444;
    color: #fff;
    cursor: pointer;
    text-align: left;
    border-radius: 2px;
    margin-bottom: 4px;
}

.option-button:hover {
    background: #3d3d3d;
}

/* Add this to show the panel when active */
.color-picker-panel.active {
    display: block;
}

/* Update existing .stat-box to include position: relative */
.stat-box {
    position: relative;
    display: flex;
    align-items: center;
    gap: 3px;
    color: #4CAF50;
    white-space: nowrap;
}
.weight-input {
    width: 50px;
    background: #1a1a1a;
    color: #4CAF50;
    border: 1px solid #444;
    padding: 4px;
    border-radius: 4px;
    text-align: center;
}

.stat-value {
    background: #1a1a1a;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #444;
    min-width: 45px;
    text-align: center;
}

/* Bottom Controls */
.range-text {
    width: 520px;
    height: 80px;
    background-color: #1a1a1a;
    color: #4CAF50;
    border: 1px solid #444;
    padding: 8px;
    margin: 3px auto;
    font-family: Arial, sans-serif;
    resize: none;
    box-sizing: border-box;
}

.button-container {
    width: 520px;
    display: flex;
    justify-content: space-between;
    margin: 3px auto;
    gap: 10px;
}

.save-button, .clear-button {
    width: 100px;
    height: 35px;
    padding: 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-weight: bold;
    line-height: 35px;
}

.save-button {
    background-color: #4CAF50;
}

.clear-button {
    background-color: #ff4444;
}

.save-button:hover {
    background-color: #45a049;
}

.clear-button:hover {
    background-color: #ff3333;
}

/* Hover Effects */
.view-button:hover:not(.active),
.row-toggle:hover:not(.active) {
    background-color: #3d3d3d;
}
     </style>
</head>
<body>
    <div class="main-container">
        <div class="controls">
            <button id="viewModeBtn" class="button active" onclick="toggleViewMode()">View Mode</button>
            <button id="rangeBuilderBtn" class="button" onclick="toggleRangeBuilder()">Range Builder</button>
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2>Range Builder</h2>
        
        <!-- View Mode Controls -->
        <div class="view-controls">
            <button class="view-button active" data-view="all">Show All</button>
            <button class="view-button" data-view="row1">Show 1</button>
            <button class="view-button" data-view="row2">Show 2</button>
        </div>

        <div class="range-grid" id="rangeGrid"></div>
        
        <!-- Control Rows Container -->
        <div class="top-controls">
            <!-- First Control Row -->
            <div class="control-row active">
                <button class="row-toggle active" data-row="1">Row 1</button>
                
                <div class="stat-box">
                    <span>Color</span>
                    <div class="color-picker-container">
                        <button class="color-swatch-button" id="colorPicker1">
                            <span class="current-color" style="background-color: #4CAF50"></span>
                        </button>
                        <div class="color-picker-panel">
                            <div class="color-section">
                                <div class="section-label">Theme Colors</div>
                                <div class="theme-colors-grid"></div>
                            </div>
                            <div class="color-section">
                                <div class="section-label">Standard Colors</div>
                                <div class="standard-colors-grid"></div>
                            </div>
                            <div class="color-section">
                                <div class="section-label">Recent Colors</div>
                                <div class="recent-colors-grid"></div>
                            </div>
                            <div class="color-options">
                                <button class="option-button no-fill">No Fill</button>
                                <button class="option-button more-colors">More Colors...</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <span>W%</span>
                    <input type="number" id="weightInput1" value="100" min="0" max="100" 
                           class="weight-input stat-value" onchange="updateWeight(this.value, 1)">
                </div>
                
                <div class="stat-box">
                    <span>%Range</span>
                    <span id="rangePercent1" class="stat-value">0</span>
                </div>
                
                <div class="stat-box">
                    <span>Combos</span>
                    <span id="comboCount1" class="stat-value">0</span>
                </div>
            </div>

            <!-- Second Control Row -->
            <div class="control-row">
                <button class="row-toggle" data-row="2">Row 2</button>
                
                <div class="stat-box">
                    <span>Color</span>
                    <div class="color-picker-container">
                        <button class="color-swatch-button" id="colorPicker2">
                            <span class="current-color" style="background-color: #FF0000"></span>
                        </button>
                        <div class="color-picker-panel">
                            <div class="color-section">
                                <div class="section-label">Theme Colors</div>
                                <div class="theme-colors-grid"></div>
                            </div>
                            <div class="color-section">
                                <div class="section-label">Standard Colors</div>
                                <div class="standard-colors-grid"></div>
                            </div>
                            <div class="color-section">
                                <div class="section-label">Recent Colors</div>
                                <div class="recent-colors-grid"></div>
                            </div>
                            <div class="color-options">
                                <button class="option-button no-fill">No Fill</button>
                                <button class="option-button more-colors">More Colors...</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <span>W%</span>
                    <input type="number" id="weightInput2" value="100" min="0" max="100" 
                           class="weight-input stat-value" onchange="updateWeight(this.value, 2)">
                </div>
                
                <div class="stat-box">
                    <span>%Range</span>
                    <span id="rangePercent2" class="stat-value">0</span>
                </div>
                
                <div class="stat-box">
                    <span>Combos</span>
                    <span id="comboCount2" class="stat-value">0</span>
                </div>
            </div>
        </div>
    
        <textarea id="rangeText" class="range-text" 
                  oninput="handleRangeTextChange(event)"></textarea>
        
        <!-- Bottom Buttons Container -->
        <div class="button-container">
            <button class="save-button" onclick="saveToCell()">Save to Cell</button>
            <button class="clear-button" onclick="clearSelection()">Clear</button>
        </div>
    </div>
</body>

 <script>
// Variables and Constants
let isViewMode = true;
let isRangeBuilderOpen = false;
let selectedCell = null;
const cellData = new Map();
const MAX_RECENT_COLORS = 10;
let currentWeights = [100, 100];
let currentColors = ['#4CAF50', '#FF0000'];
let activeRow = 0;
let isMouseDown = false;
let isSelecting = null;
let currentView = 'all';
let recentColors = JSON.parse(localStorage.getItem('recentColors') || '[]');
let colorPickerPosition = JSON.parse(localStorage.getItem('colorPickerPosition') || '{"x": 0, "y": 0}');
let isDragging = false;
let dragStartX, dragStartY;

// Color Palettes
const themeColors = [
    ['#FFFFFF', '#000000', '#E7E6E6', '#44546A', '#4472C4', '#ED7D31', '#A5A5A5', '#FFC000', '#5B9BD5', '#70AD47'],
    ['#F2F2F2', '#7F7F7F', '#D0CECE', '#D6DCE4', '#D9E2F3', '#FBE5D6', '#EDEDED', '#FFF2CC', '#DEEBF7', '#E2EFD9'],
    ['#D8D8D8', '#595959', '#AEAAAA', '#ACB9CA', '#B4C6E7', '#F7CBAC', '#DBDBDB', '#FFE699', '#BDD7EE', '#C6E0B4'],
    ['#BFBFBF', '#3F3F3F', '#757070', '#8496B0', '#8EAADB', '#F4B183', '#C9C9C9', '#FFD966', '#9CC3E5', '#A9D18E'],
    ['#A5A5A5', '#262626', '#3A3838', '#323F4F', '#2F5496', '#C55A11', '#7B7B7B', '#BF9000', '#2E75B5', '#538135'],
    ['#7F7F7F', '#0C0C0C', '#171717', '#222A35', '#1F3864', '#833C0C', '#525252', '#7F6000', '#1F4E79', '#375623']
];

const standardColors = [
    '#C00000', '#FF0000', '#FFC000', '#FFD966', '#92D050', '#00B050', '#00B0F0', '#0070C0', '#002060', '#7030A0'
];

// Color Picker Core Functions
function handleColorPickerClick(e) {
    const button = e.currentTarget;
    const panel = button.nextElementSibling;
    const rowIndex = button.id === 'colorPicker1' ? 0 : 1;

    // Close any other open panels
    document.querySelectorAll('.color-picker-panel').forEach(p => {
        if (p !== panel) p.classList.remove('active');
    });

    // Toggle current panel
    panel.classList.toggle('active');

    if (panel.classList.contains('active')) {
        // Position the panel
        positionColorPicker(panel, button);

        // Generate colors if not already done
        if (!panel.dataset.initialized) {
            generateColorPalette(panel, rowIndex);
            panel.dataset.initialized = 'true';
        }
    }

    // Close panel when clicking outside
    const closePanel = (event) => {
        if (!panel.contains(event.target) && event.target !== button) {
            panel.classList.remove('active');
            document.removeEventListener('click', closePanel);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closePanel);
    }, 0);
}

function generateColorPalette(panel, rowIndex) {
    // Generate theme colors
    const themeGrid = panel.querySelector('.theme-colors-grid');
    themeColors.forEach(row => {
        row.forEach(color => {
            const swatch = createColorSwatch(color, rowIndex);
            themeGrid.appendChild(swatch);
        });
    });

    // Generate standard colors
    const standardGrid = panel.querySelector('.standard-colors-grid');
    standardColors.forEach(color => {
        const swatch = createColorSwatch(color, rowIndex);
        standardGrid.appendChild(swatch);
    });

    // Update recent colors
    updateRecentColorsPanel(panel);
}

function createColorSwatch(color, rowIndex) {
    const swatch = document.createElement('div');
    swatch.className = 'color-swatch';
    swatch.style.backgroundColor = color;
    swatch.dataset.color = color;
    swatch.dataset.rowIndex = rowIndex;
    return swatch;
}

function selectColor(color, rowIndex) {
    // Update color immediately
    currentColors[rowIndex] = color;
    
    // Update visual immediately
    const button = document.getElementById(`colorPicker${rowIndex + 1}`);
    button.querySelector('.current-color').style.backgroundColor = color;

    // Add to recent colors efficiently
    addToRecentColors(color);
    
    // Update everything else
    updateRangeDisplay(currentView);
    saveColorSettings(rowIndex);

    // Close panel
    const panel = button.nextElementSibling;
    panel.classList.remove('active');
}

function addToRecentColors(color) {
    // Remove if already exists
    const index = recentColors.indexOf(color);
    if (index > -1) {
        recentColors.splice(index, 1);
    }
    
    // Add to front
    recentColors.unshift(color);
    
    // Keep only MAX_RECENT_COLORS
    if (recentColors.length > MAX_RECENT_COLORS) {
        recentColors.pop();
    }
    
    // Save to localStorage
    localStorage.setItem('recentColors', JSON.stringify(recentColors));
    
    // Update all panels
    document.querySelectorAll('.color-picker-panel').forEach(updateRecentColorsPanel);
}

function updateRecentColorsPanel(panel) {
    const recentGrid = panel.querySelector('.recent-colors-grid');
    const section = recentGrid.closest('.color-section');
    
    if (recentColors.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    recentGrid.innerHTML = '';
    
    const rowIndex = panel.closest('.control-row').dataset.row - 1;
    recentColors.forEach(color => {
        const swatch = createColorSwatch(color, rowIndex);
        recentGrid.appendChild(swatch);
    });
}

// Position and Dragging Functions
function positionColorPicker(panel, button) {
    const buttonRect = button.getBoundingClientRect();
    const panelRect = panel.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;

    // If we have a saved position, use it
    if (colorPickerPosition.x !== 0 || colorPickerPosition.y !== 0) {
        panel.style.position = 'fixed';
        panel.style.left = `${colorPickerPosition.x}px`;
        panel.style.top = `${colorPickerPosition.y}px`;
        return;
    }

    // Otherwise, calculate the best position
    let left = buttonRect.left;
    let top = buttonRect.bottom + 5;

    // Check if panel would go off the bottom of the screen
    if (top + panelRect.height > viewportHeight) {
        top = buttonRect.top - panelRect.height - 5;
    }

    // Check if panel would go off the right of the screen
    if (left + panelRect.width > viewportWidth) {
        left = viewportWidth - panelRect.width - 5;
    }

    panel.style.position = 'fixed';
    panel.style.left = `${left}px`;
    panel.style.top = `${top}px`;
}

function initializeDragging() {
    document.querySelectorAll('.color-picker-panel').forEach(panel => {
        // Add draggable header
        const header = document.createElement('div');
        header.className = 'color-picker-header';
        header.innerHTML = '⋮⋮'; // Drag handle icon
        panel.insertBefore(header, panel.firstChild);

        header.addEventListener('mousedown', startDragging);
    });
}

function startDragging(e) {
    const panel = e.target.closest('.color-picker-panel');
    isDragging = true;
    dragStartX = e.clientX - panel.offsetLeft;
    dragStartY = e.clientY - panel.offsetTop;

    const moveHandler = (e) => {
        if (isDragging) {
            const x = e.clientX - dragStartX;
            const y = e.clientY - dragStartY;
            panel.style.left = `${x}px`;
            panel.style.top = `${y}px`;
            colorPickerPosition = { x, y };
            localStorage.setItem('colorPickerPosition', JSON.stringify(colorPickerPosition));
        }
    };

    const upHandler = () => {
        isDragging = false;
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', upHandler);
    };

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
}

// Grid Creation Functions
function createGrid() {
    const grid = document.getElementById('grid');
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const cellId = `${String.fromCharCode(65 + j)}${i + 1}`;
            
            const cellContent = document.createElement('div');
            cellContent.className = 'cell-content';
            
            const cellIdSpan = document.createElement('span');
            cellIdSpan.className = 'cell-id';
            cellIdSpan.textContent = cellId;
            
            cell.appendChild(cellIdSpan);
            cell.appendChild(cellContent);
            cell.dataset.id = cellId;
            
            cell.addEventListener('click', selectCell);
            cell.setAttribute('draggable', true);
            cell.addEventListener('dragstart', handleDragStart);
            cell.addEventListener('dragover', handleDragOver);
            cell.addEventListener('drop', handleDrop);
            
            grid.appendChild(cell);
        }
    }
}

function createRangeGrid() {
    const rangeGrid = document.getElementById('rangeGrid');
    const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
    
    for (let i = 0; i < ranks.length; i++) {
        for (let j = 0; j < ranks.length; j++) {
            const cell = document.createElement('div');
            cell.className = 'range-cell';
            
            const textSpan = document.createElement('span');
            if (i === j) {
                textSpan.textContent = ranks[i] + ranks[j];
            } else if (i < j) {
                textSpan.textContent = ranks[i] + ranks[j] + 's';
            } else {
                textSpan.textContent = ranks[j] + ranks[i] + 'o';
            }
            cell.appendChild(textSpan);

            cell.addEventListener('mousedown', startRangeSelection);
            cell.addEventListener('mouseover', updateRangeSelection);
            
            rangeGrid.appendChild(cell);
        }
    }
    
    document.addEventListener('mouseup', endRangeSelection);
}

// Range Handling Functions
function toggleRangeCell(cell) {
    const activeRowToggle = document.querySelector(`.row-toggle[data-row="${activeRow + 1}"]`);
    if (!activeRowToggle?.classList.contains('active')) return;

    if (!cell.dataset.selections) {
        cell.dataset.selections = JSON.stringify([]);
    }
    
    let selections = JSON.parse(cell.dataset.selections);
    const currentColor = currentColors[activeRow];
    const currentWeight = currentWeights[activeRow];
    
    const otherRowSelections = selections.filter(s => currentColors.indexOf(s.color) !== activeRow);
    const existingSelection = selections.find(s => currentColors.indexOf(s.color) === activeRow);

    if (existingSelection) {
        if (existingSelection.color === currentColor && existingSelection.weight === currentWeight) {
            selections = otherRowSelections;
        } else {
            selections = [...otherRowSelections, { color: currentColor, weight: currentWeight }];
        }
    } else {
        selections = [...otherRowSelections, { color: currentColor, weight: currentWeight }];
    }
    
    cell.dataset.selections = JSON.stringify(selections);
    updateCellVisual(cell);
    updateRangeText();
    updateStats();
}

function updateCellVisual(cell) {
    const selections = JSON.parse(cell.dataset.selections || '[]');
    
    if (selections.length === 0) {
        cell.style.background = '#1a1a1a';
        cell.classList.remove('selected');
        return;
    }

    cell.classList.add('selected');
    
    if (selections.length === 1) {
        const {color, weight} = selections[0];
        cell.style.background = `linear-gradient(to right, ${color} ${weight}%, #1a1a1a ${weight}%)`;
    } else {
        selections.sort((a, b) => currentColors.indexOf(a.color) - currentColors.indexOf(b.color));
        
        let gradientString = 'linear-gradient(to right, ';
        let currentPosition = 0;
        
        selections.forEach((selection, index) => {
            gradientString += `${selection.color} ${currentPosition}% ${currentPosition + selection.weight}%`;
            currentPosition += selection.weight;
            
            if (index < selections.length - 1) {
                gradientString += ', ';
            }
        });
        
        gradientString += `, #1a1a1a ${currentPosition}%)`;
        cell.style.background = gradientString;
    }
}

function updateStats() {
    const selectedCells = document.querySelectorAll('.range-cell');
    let totalCombos = [0, 0];
    
    selectedCells.forEach(cell => {
        const hand = cell.querySelector('span').textContent;
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        if (selections.length === 0) return;
        
        let handCombos = 0;
        if (hand.length === 2) {
            handCombos = 6;
        } else if (hand.endsWith('s')) {
            handCombos = 4;
        } else if (hand.endsWith('o')) {
            handCombos = 12;
        }
        
        selections.forEach(selection => {
            const rowIndex = currentColors.indexOf(selection.color);
            if (rowIndex !== -1) {
                totalCombos[rowIndex] += handCombos * (selection.weight / 100);
            }
        });
    });
    
    const totalPossibleCombos = 1326;
    totalCombos.forEach((combos, index) => {
        const rangePercentage = (combos / totalPossibleCombos * 100).toFixed(1);
        document.getElementById(`rangePercent${index + 1}`).textContent = rangePercentage + '%';
        document.getElementById(`comboCount${index + 1}`).textContent = Math.round(combos);
    });
}

// Event Handlers and Selection Functions
function startRangeSelection(e) {
    isMouseDown = true;
    const cell = e.target.closest('.range-cell');
    const selections = JSON.parse(cell.dataset.selections || '[]');
    isSelecting = !selections.some(s => s.color === currentColors[activeRow]);
    toggleRangeCell(cell);
}

function updateRangeSelection(e) {
    if (!isMouseDown || isSelecting === null) return;
    const cell = e.target.closest('.range-cell');
    if (!cell) return;
    
    const selections = JSON.parse(cell.dataset.selections || '[]');
    const hasCurrentColor = selections.some(s => s.color === currentColors[activeRow]);
    
    if (hasCurrentColor !== isSelecting) {
        toggleRangeCell(cell);
    }
}

function endRangeSelection() {
    isMouseDown = false;
    isSelecting = null;
}

function handleViewChange(e) {
    document.querySelectorAll('.view-button').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    
    currentView = e.target.dataset.view;
    updateRangeDisplay(currentView);
}

function handleRowToggle(e) {
    document.querySelectorAll('.row-toggle').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.control-row').forEach(row => row.classList.remove('active'));
    
    e.target.classList.add('active');
    e.target.closest('.control-row').classList.add('active');
    
    activeRow = parseInt(e.target.dataset.row) - 1;
}

function updateRangeDisplay(view) {
    const cells = document.querySelectorAll('.range-cell');
    
    cells.forEach(cell => {
        const selections = JSON.parse(cell.dataset.selections || '[]');
        
        switch(view) {
            case 'row1':
                cell.style.opacity = selections.some(s => s.color === currentColors[0]) ? '1' : '0.3';
                break;
            case 'row2':
                cell.style.opacity = selections.some(s => s.color === currentColors[1]) ? '1' : '0.3';
                break;
            case 'all':
                cell.style.opacity = '1';
                break;
        }
    });
}

// View Mode and Range Builder Toggle Functions
function toggleViewMode() {
    isViewMode = true;
    isRangeBuilderOpen = false;
    
    document.getElementById('viewModeBtn').classList.add('active');
    document.getElementById('rangeBuilderBtn').classList.remove('active');
    
    document.getElementById('sidebar').style.display = 'none';
}

function toggleRangeBuilder() {
    isRangeBuilderOpen = !isRangeBuilderOpen;
    isViewMode = !isRangeBuilderOpen;
    
    document.getElementById('viewModeBtn').classList.toggle('active', !isRangeBuilderOpen);
    document.getElementById('rangeBuilderBtn').classList.toggle('active', isRangeBuilderOpen);
    
    document.getElementById('sidebar').style.display = isRangeBuilderOpen ? 'flex' : 'none';
}

// Cell and Range Text Functions
function updateRangeText() {
    const cells = [...document.querySelectorAll('.range-cell')];
    const selectionsByColorAndWeight = {};
    
    cells.forEach(cell => {
        const selections = JSON.parse(cell.dataset.selections || '[]');
        selections.forEach(({color, weight}) => {
            const key = `${color}_${weight}`;
            if (!selectionsByColorAndWeight[key]) {
                selectionsByColorAndWeight[key] = [];
            }
            selectionsByColorAndWeight[key].push(cell.querySelector('span').textContent);
        });
    });
    
    const formattedGroups = Object.entries(selectionsByColorAndWeight)
        .map(([key, hands]) => {
            const [color, weight] = key.split('_');
            return `[${weight}:${color}]${hands.join(',')}[/${weight}]`;
        });
    
    document.getElementById('rangeText').value = formattedGroups.join(',');
}

function handleRangeTextChange(e) {
    const text = e.target.value.trim();
    
    document.querySelectorAll('.range-cell').forEach(cell => {
        cell.dataset.selections = JSON.stringify([]);
        updateCellVisual(cell);
    });
    
    if (text) {
        const weightGroups = text.match(/\[\d+:[#\w]+\][^[]+\[\/\d+\]/g) || [];
        weightGroups.forEach(group => {
            const [_, weight, color] = group.match(/\[(\d+):([#\w]+)\]/);
            const hands = group.match(/\]([^[]+)\[/)[1].split(',');
            
            hands.forEach(hand => {
                const cell = [...document.querySelectorAll('.range-cell')]
                    .find(cell => cell.querySelector('span').textContent.trim() === hand.trim());
                if (cell) {
                    const selections = JSON.parse(cell.dataset.selections || '[]');
                    selections.push({color, weight: parseInt(weight)});
                    cell.dataset.selections = JSON.stringify(selections);
                    updateCellVisual(cell);
                }
            });
        });
    }
    updateStats();
}

function updateCellContent(cellId) {
    const cell = document.querySelector(`[data-id="${cellId}"]`);
    const content = cell.querySelector('.cell-content');
    const data = cellData.get(cellId);
    content.innerHTML = data ? '📝' : '';
}

// Keep only this one DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
    createGrid();
    createRangeGrid();
    toggleViewMode();
    
    // Color picker event listeners
    document.getElementById('colorPicker1').addEventListener('click', handleColorPickerClick);
    document.getElementById('colorPicker2').addEventListener('click', handleColorPickerClick);
    
    document.querySelectorAll('.view-button').forEach(button => {
        button.addEventListener('click', handleViewChange);
    });
    
    document.querySelectorAll('.row-toggle').forEach(button => {
        button.addEventListener('click', handleRowToggle);
    });
    
    // Event delegation for color swatches
    document.addEventListener('click', e => {
        const swatch = e.target.closest('.color-swatch');
        if (swatch) {
            const color = swatch.dataset.color;
            const rowIndex = parseInt(swatch.dataset.rowIndex);
            selectColor(color, rowIndex);
        }
    });
    
    loadSavedColors();
    initializeDragging();
});
</script>
</body>
</html>
